<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gemini 2.5 Flash Image — Multi Image Studio (+ Crop)</title>
  <!-- favicon path stays unchanged -->
  <link rel="icon" type="image/x-icon" href="D:\\Portable Soft\\Portable Utilitys\\ЯРЛЫКИ\\nano-banana.ico">
  <!-- Primary and cropper styles -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="cropper.css">
</head>
<body>
  <div class="app" role="application" aria-label="Gemini 2.5 Flash Image Studio">
    <header>
      <div class="left">
        <div class="logo" aria-hidden="true"></div>
        <h1>Image Flash Studio</h1>
        <span class="tiny" style="opacity:.8">Multi-image (1–4) · Gemini 2.5 Flash Image (preview)</span>
      </div>
      <div class="controls">
        <button id="resetBtn" aria-label="Очистить сцену">Очистить</button>
      </div>
    </header>

    <main role="main" aria-live="polite">
      <section class="stage" id="stage" aria-label="Холст/галерея">
        <canvas id="canvas" aria-label="Canvas"></canvas>
        <a id="imgLink" class="img-wrap" download="variant.png"><img id="imgView" alt="Результат" draggable="true"></a>
        <div id="inputGrid" class="input-grid"></div>

        <div class="top-left">
          <span class="badge hidden" id="variantBadge"></span>
          <!-- Кнопка для кроппера будет добавлена динамически -->
        </div>

        <div class="top-right">
          <button class="icon-btn" id="toggleViewBtn" aria-label="Свернуть/показать результат" title="Свернуть/показать результат">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3l9 5-9 5-9-5 9-5Zm-7 9l7 4 7-4M5 16l7 4 7-4" stroke="#cfe6ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <button class="icon-btn" id="closeBtn" aria-label="Очистить сцену">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="#cfe6ff" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>

        <div class="dropzone" id="dz" aria-label="Зона загрузки" aria-dropeffect="copy">
          <div class="dz-inner">
            <div><strong>Перетащи изображения (до 4)</strong> сюда<br/>или нажми для выбора файлов</div>
            <div class="paste-hint">Работает и <span class="kbd">Ctrl/⌘+V</span></div>
            <input id="fileInput" class="hidden" type="file" accept="image/*" multiple />
          </div>
        </div>

        <div class="carousel-nav" id="carouselNav" aria-hidden="true" aria-label="Навигация по вариантам">
          <button class="nav-btn left" id="prevBtn" aria-label="Предыдущий (←)">←</button>
          <button class="nav-btn right" id="nextBtn" aria-label="Следующий (→)">→</button>
        </div>
      </section>

      <section class="prompt-panel" id="promptPanel" aria-label="Панель промта">
        <div class="prompt-row">
          <!-- Кнопка выбора файлов / загрузки -->
          <button id="openPickerBtn" class="tool-btn" title="Загрузить изображения" aria-label="Загрузить изображения">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v12m0 0l-4-4m4 4l4-4M5 21h14" stroke="#cfe6ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <!-- Поле для промта -->
          <textarea id="prompt" placeholder="Промт (RU/EN)." aria-label="Промт"></textarea>
          <!-- Группа элементов отправки -->
          <div class="send-group">
            <!-- Magic (улучшить черновик) -->
            <button id="magicBtn" class="tool-btn" title="Magic — улучшить черновик" aria-label="Magic">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 15l9-9m-7 7l4 4M3 21l3-3m9-13l3-3M14 7l3 3" stroke="#cfe6ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <!-- Перевод RU→EN -->
            <label class="switch inline" title="Переводить перед отправкой">
              <span>Перевод</span>
              <input id="translateToggle" type="checkbox" />
            </label>
            <!-- Соотношение сторон (только без исходников) -->
            <select id="arSelect" class="mini-sel ar-sel" aria-label="Aspect Ratio" title="Соотношение сторон (только без исходников)">
              <option value="1:1">1:1</option><option value="16:9">16:9</option><option value="9:16">9:16</option>
              <option value="4:5">4:5</option><option value="5:4">5:4</option><option value="3:2">3:2</option>
              <option value="2:3">2:3</option><option value="4:3">4:3</option><option value="3:4">3:4</option>
              <option value="21:9">21:9</option><option value="9:21">9:21</option>
            </select>
            <!-- Персональные промты для каждого изображения (показывается при >1 изображении) -->
            <label id="perImageLabel" class="switch hidden" title="Персональные промты для каждого изображения">
              <span>пер-изобр.</span>
              <input id="perImageToggle" type="checkbox" />
            </label>
            <!-- Количество вариантов -->
            <select id="varCount" class="mini-sel" aria-label="Количество вариантов">
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
            </select>
            <!-- Кнопка отправки -->
            <button id="sendBtn" class="tool-btn" title="Отправить" aria-label="Отправить">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 4l16 8-16 8 4-8-4-8zM8 12h8" stroke="#cfe6ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <!-- Кнопка обработки фото (A/B) -->
            <button id="processPhotoBtn" class="tool-btn" title="Обработать фото" aria-label="Обработать фото">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M4 7h4l2-2h4l2 2h4v10H4V7Z" stroke="#cfe6ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="3.5" stroke="#cfe6ff" stroke-width="2"/>
              </svg>
            </button>
            <!-- Кнопка пресетов (список промтов) -->
            <button id="openPresetsBtn" class="tool-btn" title="Пресеты" aria-label="Пресеты">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M4 6h16M4 12h16M4 18h10" stroke="#cfe6ff" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>
      </section>
    </main>

    <aside aria-label="Детали и история" role="complementary">
      <div class="details">
        <div class="d-row">
          <div class="d-meta" id="activeMeta">Нет активного изображения</div>
          <!-- Персональный промт для активного изображения -->
          <textarea id="activePerPrompt" class="d-prompt hidden" placeholder="Персональный промт для активного изображения (RU/EN)"></textarea>
        </div>
      </div>
      <div class="aside-head">
        <div class="tiny">История (до 10):</div>
        <button id="clearHistBtn" class="tiny">Очистить историю</button>
      </div>
      <div id="history" class="scroll" role="list"></div>
    </aside>
  </div>

  <!-- Окно кадрирования -->
  <div id="cropModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="cropTitle" aria-describedby="cropDesc" style="display:none">
    <div class="modal-card" style="max-width:960px">
      <div class="modal-head">
        <div class="modal-title" id="cropTitle">Кадрирование</div>
        <div id="cropDesc" class="small" style="opacity:.85">Перетащи или потяни за углы/грани. Колёсико — масштаб холста. Enter — применить, Esc — отмена.</div>
      </div>
      <div style="position:relative; background:#0b111a; border:1px solid #1b2737; border-radius:12px; overflow:hidden; aspect-ratio:16/9; max-height:70vh;">
        <canvas id="cropCanvas" style="display:block; width:100%; height:100%;"></canvas>
        <div id="cropOverlay" aria-label="Область обрезки" style="position:absolute; inset:auto; border:2px solid #69b9ff; box-shadow:0 0 0 200vmax rgba(0,0,0,.45); border-radius:8px; cursor:move;"></div>
        <div class="cr-h cr-nw" data-dir="nw"></div>
        <div class="cr-h cr-n"  data-dir="n"></div>
        <div class="cr-h cr-ne" data-dir="ne"></div>
        <div class="cr-h cr-e"  data-dir="e"></div>
        <div class="cr-h cr-se" data-dir="se"></div>
        <div class="cr-h cr-s"  data-dir="s"></div>
        <div class="cr-h cr-sw" data-dir="sw"></div>
        <div class="cr-h cr-w"  data-dir="w"></div>
      </div>
      <div class="modal-actions" style="margin-top:10px">
        <div class="row" style="gap:10px; align-items:center;">
          <label class="switch inline" title="Фиксировать соотношение сторон">
            <span>Фикс. AR</span>
            <input id="cropLockAR" type="checkbox" />
          </label>
          <select id="cropAR" class="mini-sel ar-sel" title="Соотношение сторон">
            <option value="free">Свободно</option>
            <option value="1:1">1:1</option>
            <option value="4:5">4:5</option>
            <option value="3:2">3:2</option>
            <option value="16:9">16:9</option>
            <option value="9:16">9:16</option>
          </select>
          <div class="grow"></div>
          <button id="cropCancel" class="btn">Отмена (Esc)</button>
          <button id="cropApply"  class="btn primary">Применить (Enter)</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Готово</div>

  <!-- Основной скрипт и скрипт кроппера -->
  <script src="script.js"></script>
  <script src="cropper.js"></script>
</body>
</html>